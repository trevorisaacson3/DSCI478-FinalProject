---
title: "InitialResearch"
author: "Trevor Isaacson"
date: "3/27/2022"
output: html_document
---


Machine Learning and Cosine Similarity? Ask about slides
Difference in measurement start of day and end of day, compare that number with snowfall two weeks out
Average measurement compared with snowfall two weeks out 
How quickly the buoy pops is going to matter
Check difference from last 12 hours and/or Height > 7?
  Use biggest difference from day to compare with daily snow totals
  Does a negative number correlate to storm ending? 
  
```{r setup, include=FALSE, echo = FALSE}
set.seed(445)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.width=5, fig.height=3) 
knitr::opts_chunk$set(message = FALSE)
library(ggplot2)
library(tidyverse)
library(tidyr)
library(e1071)
library(rmarkdown)
library(glmnet)
library(knitr)
library(dplyr)
library(zoo)
library(tree)
library(randomForest)
```

## Original Buoy Data
```{r}
originalBuoy2019 = read.delim("./buoyData/originalBuoy2019.txt", header = FALSE, sep = "")
colnames(originalBuoy2019) = c("Year", "Month", "Day", "Hour", "Minute", "WindDir", "WindSpeed", "GustSpeed", "WaveHeight", "DominantWavePeriod", "AverageWavePeriod", "DirWavePeriod", "SeaLevelPressure", "AirTemp", "SeaSurfaceTemp", "DewpointTemp", "Visibility", "Tide")
originalBuoy2019 = originalBuoy2019[-c(1),]

originalBuoy2020 = read.delim("./buoyData/originalBuoy2020.txt", header = FALSE, sep = "")
colnames(originalBuoy2020) = c("Year", "Month", "Day", "Hour", "Minute", "WindDir", "WindSpeed", "GustSpeed", "WaveHeight", "DominantWavePeriod", "AverageWavePeriod", "DirWavePeriod", "SeaLevelPressure", "AirTemp", "SeaSurfaceTemp", "DewpointTemp", "Visibility", "Tide")
originalBuoy2020 = originalBuoy2020[-c(1),]
```

```{r}
# the measurements we want are measured at minute 40
originalBuoy2019 = originalBuoy2019 %>%
  # these aren't measured and remain static
  select(-c("Tide", "Visibility")) %>%
  filter(Minute == 40)

originalBuoy2019 = originalBuoy2019 %>%
  mutate(WindSpeed = as.numeric(as.character(WindSpeed))) %>%
  mutate(GustSpeed = as.numeric(as.character(GustSpeed))) %>%
  mutate(AirTemp = as.numeric(as.character(AirTemp))) %>%
  mutate(SeaSurfaceTemp = as.numeric(as.character(SeaSurfaceTemp))) %>%
  mutate(DewpointTemp = as.numeric(as.character(DewpointTemp))) %>%
  mutate(WaveHeight = as.numeric(as.character(WaveHeight))) %>%
  mutate(DominantWavePeriod = as.numeric(as.character(DominantWavePeriod))) %>%
  mutate(AverageWavePeriod = as.numeric(as.character(AverageWavePeriod))) %>%
  mutate(DirWavePeriod = as.numeric(as.character(DirWavePeriod))) %>%
  mutate(SeaLevelPressure = as.numeric(as.character(SeaLevelPressure))) %>%
  mutate(WindDir = as.numeric(as.character(WindDir))) %>%
  mutate(Day = as.numeric(as.character(Day))) %>%
  mutate(Month = as.numeric(as.character(Month))) %>%
  mutate(Year = as.numeric(as.character(Year))) %>%
  filter(WaveHeight != 99.00)

originalBuoy2020 = originalBuoy2020 %>%
  # these aren't measured and remain static
  select(-c("Tide", "Visibility")) %>%
  filter(Minute == 40)

originalBuoy2020 = originalBuoy2020 %>%
  mutate(WindSpeed = as.numeric(as.character(WindSpeed))) %>%
  mutate(GustSpeed = as.numeric(as.character(GustSpeed))) %>%
  mutate(AirTemp = as.numeric(as.character(AirTemp))) %>%
  mutate(SeaSurfaceTemp = as.numeric(as.character(SeaSurfaceTemp))) %>%
  mutate(DewpointTemp = as.numeric(as.character(DewpointTemp))) %>%
  mutate(WaveHeight = as.numeric(as.character(WaveHeight))) %>%
  mutate(DominantWavePeriod = as.numeric(as.character(DominantWavePeriod))) %>%
  mutate(AverageWavePeriod = as.numeric(as.character(AverageWavePeriod))) %>%
  mutate(DirWavePeriod = as.numeric(as.character(DirWavePeriod))) %>%
  mutate(SeaLevelPressure = as.numeric(as.character(SeaLevelPressure))) %>%
  mutate(WindDir = as.numeric(as.character(WindDir))) %>%
  mutate(Day = as.numeric(as.character(Day))) %>%
  mutate(Month = as.numeric(as.character(Month))) %>%
  mutate(Year = as.numeric(as.character(Year))) %>%
  filter(WaveHeight != 99.00)

originalBuoy2019
# originalBuoy2020
```


AverageDailyDataXXXX is the daily averages for the total data
```{r}
# create mean for entire day
AverageDailyData2019 = originalBuoy2019 %>%
  group_by(Year, Month, Day) %>%
  summarise(across(c(WindDir:DewpointTemp), ~ mean(.x, na.rm = TRUE)))
  
AverageDailyData2020 = originalBuoy2020 %>%
  group_by(Year, Month, Day) %>%
  summarise(across(c(WindDir:DewpointTemp), ~ mean(.x, na.rm = TRUE)))

# AverageDailyData2019
# AverageDailyData2020
```

## Park City Snowfall Data
```{r}
ParkCity2019 = read.csv("./snowfallData/ParkCitySnowfall2019.csv")
ParkCity2020 = read.csv("./snowfallData/ParkCitySnowfall2020.csv")
ParkCity2021 = read.csv("./snowfallData/ParkCitySnowfall2021.csv")
```

```{r warning = FALSE}
# change M, T and - to 0
ParkCity2019 = ParkCity2019 %>%
  mutate_if(is.factor, as.character) %>%
  mutate_if(is.character, as.numeric)
ParkCity2019[is.na(ParkCity2019)] <- 0

ParkCity2020 = ParkCity2020 %>%
  mutate_if(is.factor, as.character) %>%
  mutate_if(is.character, as.numeric)
ParkCity2020[is.na(ParkCity2020)] <- 0

ParkCity2021 = ParkCity2021 %>%
  mutate_if(is.factor, as.character) %>%
  mutate_if(is.character, as.numeric)
ParkCity2021[is.na(ParkCity2021)] <- 0

ParkCity2019 %>%
  ggplot(aes(x = Day, y = Snowfall)) +
    geom_line() +
    facet_wrap(~Month)
ParkCity2020 %>%
  ggplot(aes(x = Day, y = Snowfall)) +
    geom_line() +
    facet_wrap(~Month)
ParkCity2021 %>%
  ggplot(aes(x = Day, y = Snowfall)) +
    geom_line() +
    facet_wrap(~Month)



```

The Dataframe ParkCity2019 shows snowfall totals for the corresponding day.  
Snowfall column shows the snowfall on that day.  
Snowfall14DaysLater shows the snowfall two weeks after that day.  This will be used to determine if waveHeight increases in Hawaii lead to snow 14 days later in Utah
```{r warning = FALSE}
# make snowtotals into one column
snowTotals2019 = stack(ParkCity2019[2:ncol(ParkCity2019)])
snowTotals2019 = snowTotals2019[-c(60,61,62,124,168,186,248,341), ]

# advanced snowfall = park city snow two weeks in advance
# remove first 14 days of year
advanceSnowTotals14Days = snowTotals2019[-c(1:14), ]
# add first 14 days of next year to end
SnowTotals14Daysinto2020 = ParkCity2020[1:14, "Jan"]
SnowTotals14Daysinto2020 = data.frame(values = SnowTotals14Daysinto2020, 
                                      ind = "Jan")
advancedSnowfall = rbind(advanceSnowTotals14Days, SnowTotals14Daysinto2020)

# create dataframe of snowfalls 
newParkCity2019 = data.frame(Year = AverageDailyData2019$Year,
                             Month = AverageDailyData2019$Month,
                             Day = AverageDailyData2019$Day,
                             Snowfall = snowTotals2019$values,
                             Snowfall14DaysLater = advancedSnowfall$values)
ParkCity2019 = newParkCity2019

AverageDailyData2019["Snowfall"] = ParkCity2019$Snowfall
AverageDailyData2019["Snowfall14DaysLater"] = ParkCity2019$Snowfall14DaysLater

AverageDailyData2019
```

```{r}
# make snowtotals into one column
snowTotals2020 = stack(ParkCity2020[2:ncol(ParkCity2020)])
snowTotals2020 = snowTotals2020[-c(60,61,124,186,194,248,341), ]

# advanced snowfall = park city snow two weeks in advance
# remove first 14 days of year
advanceSnowTotals14Days = snowTotals2020[-c(1:14), ]
# add first 14 days of next year to end
SnowTotals14Daysinto2021 = ParkCity2021[1:14, "Jan"]
SnowTotals14Daysinto2021 = data.frame(values = SnowTotals14Daysinto2021, ind = "Jan")

advancedSnowfall = rbind(advanceSnowTotals14Days, SnowTotals14Daysinto2021)

# create dataframe of snowfalls 
newParkCity2020 = data.frame(Year = AverageDailyData2020$Year,
                             Month = AverageDailyData2020$Month,
                             Day = AverageDailyData2020$Day,
                             Snowfall = snowTotals2020$values,
                             Snowfall14DaysLater = advancedSnowfall$values)
ParkCity2020 = newParkCity2020

AverageDailyData2020["Snowfall"] = ParkCity2020$Snowfall
AverageDailyData2020["Snowfall14DaysLater"] = ParkCity2020$Snowfall14DaysLater

AverageDailyData2020

```

```{r}
ggplot(data = AverageDailyData2020, aes(x = Day, y = WaveHeight)) +
  geom_line() +
  facet_wrap(~Month)

ggplot(data = ParkCity2020, aes(x = Day, y = Snowfall14DaysLater)) +
  geom_line() +
  facet_wrap(~Month)
```

Linear Regression
```{r}
totalDaily = rbind(AverageDailyData2019, AverageDailyData2020)

totalDaily = totalDaily %>%
  ungroup() %>%
  select(-c("Year", "Month", "Day"))

totalDaily
predictedSnow = lm(Snowfall14DaysLater ~ DewpointTemp + WaveHeight + AirTemp + AverageWavePeriod , data = totalDaily)
summary(predictedSnow)

```

Trees
```{r}
initial_tree = tree(Snowfall14DaysLater ~ ., data = totalDaily)
summary(initial_tree)
plot(initial_tree)
text(initial_tree, cex = 0.65, digits = 4, pretty = 0)
initial_tree

# pruned by CV
prune_initial <- prune.tree(initial_tree, best = 8)
plot(prune_initial)
text(prune_initial, cex = 0.65, digits = 4, pretty = 0)
```

Bagging: 
mtry = uses all the variables/predictors 
```{r}
bag_fit <- randomForest(Snowfall14DaysLater ~ ., data = totalDaily, mtry = ncol(totalDaily) - 1, importance = TRUE)
plot(bag_fit)

data.frame(bag_fit$importance) %>%
  mutate(variable = rownames(bag_fit$importance)) %>%
  mutate(variable = factor(variable, levels = variable[order(X.IncMSE)])) %>%
  ggplot() + ggtitle("Predictive Power") + xlab("% Decreasing MSE") + 
  geom_point(aes(X.IncMSE, variable))  

data.frame(bag_fit$importance) %>%
  mutate(variable = rownames(bag_fit$importance)) %>%
  mutate(variable = factor(variable, levels = variable[order(IncNodePurity)])) %>%
  ggplot() + ggtitle("Predictive Power") + xlab("Node Purity") + 
  geom_point(aes(IncNodePurity, variable))  
```









