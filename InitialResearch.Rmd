---
title: "InitialResearch"
author: "Trevor Isaacson"
date: "3/27/2022"
output: html_document
---


Machine Learning and Cosine Similarity? Ask about slides
Difference in measurement start of day and end of day, compare that number with snowfall two weeks out
Average measurement compared with snowfall two weeks out 
How quickly the buoy pops is going to matter
Check difference from last 12 hours and/or Height > 7?
  Use biggest difference from day to compare with daily snow totals
  Does a negative number correlate to storm ending? 
  
```{r setup, include=FALSE, echo = FALSE}
set.seed(445)
knitr::opts_chunk$set(echo = FALSE)
# knitr::opts_chunk$set(fig.width=5, fig.height=3) 
knitr::opts_chunk$set(message = FALSE)
library(ggplot2)
library(tidyverse)
library(tidyr)
library(e1071)
library(rmarkdown)
library(glmnet)
library(knitr)
library(dplyr)
library(zoo)
library(tree)
library(randomForest)
```

## Original Buoy Data
```{r}
originalBuoy2019 = read.delim("./buoyData/originalBuoy2019.txt", header = FALSE, sep = "")
colnames(originalBuoy2019) = c("Year", "Month", "Day", "Hour", "Minute", "WindDir", "WindSpeed", "GustSpeed", "WaveHeight", "DominantWavePeriod", "AverageWavePeriod", "DirWavePeriod", "SeaLevelPressure", "AirTemp", "SeaSurfaceTemp", "DewpointTemp", "Visibility", "Tide")
originalBuoy2019 = originalBuoy2019[-c(1),]

originalBuoy2020 = read.delim("./buoyData/originalBuoy2020.txt", header = FALSE, sep = "")
colnames(originalBuoy2020) = c("Year", "Month", "Day", "Hour", "Minute", "WindDir", "WindSpeed", "GustSpeed", "WaveHeight", "DominantWavePeriod", "AverageWavePeriod", "DirWavePeriod", "SeaLevelPressure", "AirTemp", "SeaSurfaceTemp", "DewpointTemp", "Visibility", "Tide")
originalBuoy2020 = originalBuoy2020[-c(1),]
```

```{r}
# the measurements we want are measured at minute 40
originalBuoy2019 = originalBuoy2019 %>%
  # these aren't measured and remain static
  select(-c("Tide", "Visibility")) %>%
  filter(Minute == 40)

originalBuoy2019 = originalBuoy2019 %>%
  mutate(WindSpeed = as.numeric(as.character(WindSpeed))) %>%
  mutate(GustSpeed = as.numeric(as.character(GustSpeed))) %>%
  mutate(AirTemp = as.numeric(as.character(AirTemp))) %>%
  mutate(SeaSurfaceTemp = as.numeric(as.character(SeaSurfaceTemp))) %>%
  mutate(DewpointTemp = as.numeric(as.character(DewpointTemp))) %>%
  mutate(WaveHeight = as.numeric(as.character(WaveHeight))) %>%
  mutate(DominantWavePeriod = as.numeric(as.character(DominantWavePeriod))) %>%
  mutate(AverageWavePeriod = as.numeric(as.character(AverageWavePeriod))) %>%
  mutate(DirWavePeriod = as.numeric(as.character(DirWavePeriod))) %>%
  mutate(SeaLevelPressure = as.numeric(as.character(SeaLevelPressure))) %>%
  mutate(WindDir = as.numeric(as.character(WindDir))) %>%
  mutate(Day = as.numeric(as.character(Day))) %>%
  mutate(Month = as.numeric(as.character(Month))) %>%
  mutate(Year = as.numeric(as.character(Year))) %>%
  filter(WaveHeight != 99.00)

originalBuoy2020 = originalBuoy2020 %>%
  # these aren't measured and remain static
  select(-c("Tide", "Visibility")) %>%
  filter(Minute == 40)

originalBuoy2020 = originalBuoy2020 %>%
  mutate(WindSpeed = as.numeric(as.character(WindSpeed))) %>%
  mutate(GustSpeed = as.numeric(as.character(GustSpeed))) %>%
  mutate(AirTemp = as.numeric(as.character(AirTemp))) %>%
  mutate(SeaSurfaceTemp = as.numeric(as.character(SeaSurfaceTemp))) %>%
  mutate(DewpointTemp = as.numeric(as.character(DewpointTemp))) %>%
  mutate(WaveHeight = as.numeric(as.character(WaveHeight))) %>%
  mutate(DominantWavePeriod = as.numeric(as.character(DominantWavePeriod))) %>%
  mutate(AverageWavePeriod = as.numeric(as.character(AverageWavePeriod))) %>%
  mutate(DirWavePeriod = as.numeric(as.character(DirWavePeriod))) %>%
  mutate(SeaLevelPressure = as.numeric(as.character(SeaLevelPressure))) %>%
  mutate(WindDir = as.numeric(as.character(WindDir))) %>%
  mutate(Day = as.numeric(as.character(Day))) %>%
  mutate(Month = as.numeric(as.character(Month))) %>%
  mutate(Year = as.numeric(as.character(Year))) %>%
  filter(WaveHeight != 99.00)

originalBuoy2019
# originalBuoy2020
```


AverageDailyDataXXXX is the daily averages for the total data
```{r}
# create mean for entire day
AverageDailyData2019 = originalBuoy2019 %>%
  group_by(Year, Month, Day) %>%
  summarise(across(c(WindDir:DewpointTemp), ~ mean(.x, na.rm = TRUE)))
  
AverageDailyData2020 = originalBuoy2020 %>%
  group_by(Year, Month, Day) %>%
  summarise(across(c(WindDir:DewpointTemp), ~ mean(.x, na.rm = TRUE)))

# AverageDailyData2019
# AverageDailyData2020
```

## Park City Snowfall Data
```{r}
PC2019 = read.csv("./snowfallData/ParkCitySnowfall2019.csv")
PC2020 = read.csv("./snowfallData/ParkCitySnowfall2020.csv")
PC2021 = read.csv("./snowfallData/ParkCitySnowfall2021.csv")
```

```{r warning = FALSE}
# change M, T and - to 0
PC2019 = PC2019 %>%
  mutate_if(is.factor, as.character) %>%
  mutate_if(is.character, as.numeric)
PC2019[is.na(PC2019)] <- 0

PC2020 = PC2020 %>%
  mutate_if(is.factor, as.character) %>%
  mutate_if(is.character, as.numeric)
PC2020[is.na(PC2020)] <- 0

PC2021 = PC2021 %>%
  mutate_if(is.factor, as.character) %>%
  mutate_if(is.character, as.numeric)
PC2021[is.na(PC2021)] <- 0

```

The Dataframe PC2019 shows snowfall totals for the corresponding day.  
Snowfall column shows the snowfall on that day.  
Snowfall14DaysLater shows the snowfall two weeks after that day.  This will be used to determine if waveHeight increases in Hawaii lead to snow 14 days later in Utah
```{r warning = FALSE}
# make snowtotals into one column
ParkCitySnowTotals2019 = stack(PC2019[2:ncol(PC2019)])
ParkCitySnowTotals2019 = ParkCitySnowTotals2019[-c(60,61,62,124,168,186,248,341), ]

# advanced snowfall = park city snow two weeks in advance
# remove first 14 days of year
advanceSnowTotals13Days = ParkCitySnowTotals2019[-c(1:13), ]
advanceSnowTotals14Days = ParkCitySnowTotals2019[-c(1:14), ]
advanceSnowTotals15Days = ParkCitySnowTotals2019[-c(1:15), ]

# add first 14 days of next year to end
SnowTotals13Daysinto2020 = PC2020[1:13, "Jan"]
SnowTotals14Daysinto2020 = PC2020[1:14, "Jan"]
SnowTotals15Daysinto2020 = PC2020[1:15, "Jan"]

SnowTotals13Daysinto2020 = data.frame(values = SnowTotals13Daysinto2020, ind = "Jan")
SnowTotals14Daysinto2020 = data.frame(values = SnowTotals14Daysinto2020, ind = "Jan")
SnowTotals15Daysinto2020 = data.frame(values = SnowTotals15Daysinto2020, ind = "Jan")

advancedSnowfall13 = rbind(advanceSnowTotals13Days, SnowTotals13Daysinto2020)
advancedSnowfall14 = rbind(advanceSnowTotals14Days, SnowTotals14Daysinto2020)
advancedSnowfall15 = rbind(advanceSnowTotals15Days, SnowTotals15Daysinto2020)

# create dataframe of snowfalls 
newPC2019 = data.frame(Year = AverageDailyData2019$Year,
                             Month = AverageDailyData2019$Month,
                             Day = AverageDailyData2019$Day,
                             Snowfall = ParkCitySnowTotals2019$values,
                             Snowfall13DaysLater = advancedSnowfall13$values,
                             Snowfall14DaysLater = advancedSnowfall14$values,
                             Snowfall15DaysLater = advancedSnowfall15$values)
PC2019 = newPC2019

AverageDailyData2019["Snowfall"] = PC2019$Snowfall
AverageDailyData2019["Snowfall13DaysLater"] = PC2019$Snowfall13DaysLater
AverageDailyData2019["Snowfall14DaysLater"] = PC2019$Snowfall14DaysLater
AverageDailyData2019["Snowfall15DaysLater"] = PC2019$Snowfall15DaysLater
AverageDailyData2019["AvgSnowfall3DayWindow"] = (PC2019$Snowfall13DaysLater + PC2019$Snowfall14DaysLater + PC2019$Snowfall15DaysLater) /3 

AverageDailyData2019
```

```{r}
# make snowtotals into one column
ParkCitySnowTotals2020 = stack(PC2020[2:ncol(PC2020)])
ParkCitySnowTotals2020 = ParkCitySnowTotals2020[-c(60,61,124,186,194,248,341), ]

# advanced snowfall = park city snow two weeks in advance
# remove first 14 days of year
advanceSnowTotals13Days = ParkCitySnowTotals2020[-c(1:13), ]
advanceSnowTotals14Days = ParkCitySnowTotals2020[-c(1:14), ]
advanceSnowTotals15Days = ParkCitySnowTotals2020[-c(1:15), ]
# add first 14 days of next year to end
SnowTotals13Daysinto2021 = PC2021[1:13, "Jan"]
SnowTotals14Daysinto2021 = PC2021[1:14, "Jan"]
SnowTotals15Daysinto2021 = PC2021[1:15, "Jan"]

SnowTotals13Daysinto2021 = data.frame(values = SnowTotals13Daysinto2021, ind = "Jan")
SnowTotals14Daysinto2021 = data.frame(values = SnowTotals14Daysinto2021, ind = "Jan")
SnowTotals15Daysinto2021 = data.frame(values = SnowTotals15Daysinto2021, ind = "Jan")

advancedSnowfall13 = rbind(advanceSnowTotals13Days, SnowTotals13Daysinto2021)
advancedSnowfall14 = rbind(advanceSnowTotals14Days, SnowTotals14Daysinto2021)
advancedSnowfall15 = rbind(advanceSnowTotals15Days, SnowTotals15Daysinto2021)

# create dataframe of snowfalls 
newPC2020 = data.frame(Year = AverageDailyData2020$Year,
                             Month = AverageDailyData2020$Month,
                             Day = AverageDailyData2020$Day,
                             Snowfall = ParkCitySnowTotals2020$values,
                             Snowfall13DaysLater = advancedSnowfall13$values,
                             Snowfall14DaysLater = advancedSnowfall14$values,
                             Snowfall15DaysLater = advancedSnowfall15$values)
PC2020 = newPC2020
AverageDailyData2020["Snowfall"] = PC2020$Snowfall
AverageDailyData2020["Snowfall13DaysLater"] = PC2020$Snowfall13DaysLater
AverageDailyData2020["Snowfall14DaysLater"] = PC2020$Snowfall14DaysLater
AverageDailyData2020["Snowfall15DaysLater"] = PC2020$Snowfall15DaysLater
AverageDailyData2020["AvgSnowfall3DayWindow"] = (PC2020$Snowfall13DaysLater + PC2020$Snowfall14DaysLater + PC2020$Snowfall15DaysLater) /3 

totalDailyParkCity = rbind(AverageDailyData2019, AverageDailyData2020)
totalDailyParkCity["Location"] = "ParkCity"

totalDailyParkCity = totalDailyParkCity %>%
  ungroup()

totalDailyParkCity
```

## Jackson Hole Snowfall Data
```{r}
JH2019 = read.csv("./snowfallData/JacksonHoleSnowfall2019.csv")
JH2020 = read.csv("./snowfallData/JacksonHoleSnowfall2020.csv")
JH2021 = read.csv("./snowfallData/JacksonHoleSnowfall2021.csv")
```

```{r warning = FALSE}
# change M, T and - to 0
JH2019 = JH2019 %>%
  mutate_if(is.factor, as.character) %>%
  mutate_if(is.character, as.numeric)
JH2019[is.na(JH2019)] <- 0

JH2020 = JH2020 %>%
  mutate_if(is.factor, as.character) %>%
  mutate_if(is.character, as.numeric)
JH2020[is.na(JH2020)] <- 0

JH2021 = JH2021 %>%
  mutate_if(is.factor, as.character) %>%
  mutate_if(is.character, as.numeric)
JH2021[is.na(JH2021)] <- 0

# Jackson Hole 2019
JHSnowTotals2019 = stack(JH2019[2:ncol(JH2019)])
JHSnowTotals2019 = JHSnowTotals2019[-c(60,61,62,124,168,186,248,341), ]
# advanced snowfall = park city snow two weeks in advance
# remove first 14 days of year
advanceSnowTotals13Days = JHSnowTotals2019[-c(1:13), ]
advanceSnowTotals14Days = JHSnowTotals2019[-c(1:14), ]
advanceSnowTotals15Days = JHSnowTotals2019[-c(1:15), ]

# add first 14 days of next year to end
SnowTotals13Daysinto2020 = JH2020[1:13, "Jan"]
SnowTotals14Daysinto2020 = JH2020[1:14, "Jan"]
SnowTotals15Daysinto2020 = JH2020[1:15, "Jan"]

SnowTotals13Daysinto2020 = data.frame(values = SnowTotals13Daysinto2020, ind = "Jan")
SnowTotals14Daysinto2020 = data.frame(values = SnowTotals14Daysinto2020, ind = "Jan")
SnowTotals15Daysinto2020 = data.frame(values = SnowTotals15Daysinto2020, ind = "Jan")

advancedSnowfall13 = rbind(advanceSnowTotals13Days, SnowTotals13Daysinto2020)
advancedSnowfall14 = rbind(advanceSnowTotals14Days, SnowTotals14Daysinto2020)
advancedSnowfall15 = rbind(advanceSnowTotals15Days, SnowTotals15Daysinto2020)

# create dataframe of snowfalls 
newJH2019 = data.frame(Year = AverageDailyData2019$Year,
                             Month = AverageDailyData2019$Month,
                             Day = AverageDailyData2019$Day,
                             Snowfall = JHSnowTotals2019$values,
                             Snowfall13DaysLater = advancedSnowfall13$values,
                             Snowfall14DaysLater = advancedSnowfall14$values,
                             Snowfall15DaysLater = advancedSnowfall15$values)
JH2019 = newJH2019
AverageDailyData2019["Snowfall"] = JH2019$Snowfall
AverageDailyData2019["Snowfall13DaysLater"] = JH2019$Snowfall13DaysLater
AverageDailyData2019["Snowfall14DaysLater"] = JH2019$Snowfall14DaysLater
AverageDailyData2019["Snowfall15DaysLater"] = JH2019$Snowfall15DaysLater
AverageDailyData2019["AvgSnowfall3DayWindow"] = (JH2019$Snowfall13DaysLater + JH2019$Snowfall14DaysLater + JH2019$Snowfall15DaysLater) /3 

# Jackson Hole 2020
JHSnowTotals2020 = stack(JH2020[2:ncol(JH2020)])
JHSnowTotals2020 = JHSnowTotals2020 [-c(60,61,124,186,194,248,341), ]

# advanced snowfall = park city snow two weeks in advance
# remove first 14 days of year
advanceSnowTotals13Days = JHSnowTotals2020 [-c(1:13), ]
advanceSnowTotals14Days = JHSnowTotals2020 [-c(1:14), ]
advanceSnowTotals15Days = JHSnowTotals2020 [-c(1:15), ]
# add first 14 days of next year to end
SnowTotals13Daysinto2021 = JH2021[1:13, "Jan"]
SnowTotals14Daysinto2021 = JH2021[1:14, "Jan"]
SnowTotals15Daysinto2021 = JH2021[1:15, "Jan"]

SnowTotals13Daysinto2021 = data.frame(values = SnowTotals13Daysinto2021, ind = "Jan")
SnowTotals14Daysinto2021 = data.frame(values = SnowTotals14Daysinto2021, ind = "Jan")
SnowTotals15Daysinto2021 = data.frame(values = SnowTotals15Daysinto2021, ind = "Jan")

advancedSnowfall13 = rbind(advanceSnowTotals13Days, SnowTotals13Daysinto2021)
advancedSnowfall14 = rbind(advanceSnowTotals14Days, SnowTotals14Daysinto2021)
advancedSnowfall15 = rbind(advanceSnowTotals15Days, SnowTotals15Daysinto2021)

# create dataframe of snowfalls 
newJH2020 = data.frame(Year = AverageDailyData2020$Year,
                             Month = AverageDailyData2020$Month,
                             Day = AverageDailyData2020$Day,
                             Snowfall = JHSnowTotals2020 $values,
                             Snowfall13DaysLater = advancedSnowfall13$values,
                             Snowfall14DaysLater = advancedSnowfall14$values,
                             Snowfall15DaysLater = advancedSnowfall15$values)
JH2020 = newJH2020
AverageDailyData2020["Snowfall"] = JH2020$Snowfall
AverageDailyData2020["Snowfall13DaysLater"] = JH2020$Snowfall13DaysLater
AverageDailyData2020["Snowfall14DaysLater"] = JH2020$Snowfall14DaysLater
AverageDailyData2020["Snowfall15DaysLater"] = JH2020$Snowfall15DaysLater
AverageDailyData2020["AvgSnowfall3DayWindow"] = (JH2020$Snowfall13DaysLater + JH2020$Snowfall14DaysLater + JH2020$Snowfall15DaysLater) /3 

totalDailyJH = rbind(AverageDailyData2019, AverageDailyData2020)
totalDailyJH["Location"] = "JacksonHole"

totalDailyJH  = totalDailyJH  %>%
  ungroup()

totalDailyJH

```


```{r}
# totalDaily = rbind(totalDailyParkCity, totalDailyJH)
# 
# totalDaily = totalDaily %>%
#   filter(Month < 5 | Month < 9) %>%
#   select(-c(Year, Month, Day, Snowfall13DaysLater, Snowfall14DaysLater, Snowfall15DaysLater)) %>%
#   mutate(Location = as.factor(Location))
# 
# totalDaily
  
trn = sample(seq_len(nrow(totalDaily)), 675)
training = totalDaily[trn, ]
testing = totalDaily[-trn, ]
```


Linear Regression with all Data
```{r}
predictedSnow = lm(AvgSnowfall3DayWindow ~ ., data = training)
summary(predictedSnow)

linear_predict = predict(predictedSnow, newdata = testing, type = "response")
MSE_testing = (testing$AvgSnowfall3DayWindow - linear_predict)^2
print(paste("MSE of Testing Set: ", round(mean(MSE_testing), 4)))
```

Trees with All Data
```{r}
initial_tree = tree(AvgSnowfall3DayWindow ~ ., data = training)
summary(initial_tree)
plot(initial_tree)
text(initial_tree, cex = 0.65, digits = 4, pretty = 0)
initial_tree

initial_predict = predict(initial_tree, newdata = testing)
tree_MSE = round(mean((testing$AvgSnowfall3DayWindow - initial_predict)^2), 4)
print(paste("Test MSE of Initial Tree: ", tree_MSE))

# cross validation
initial_cv = cv.tree(initial_tree)
ggplot() +
  geom_point(aes(x = initial_cv$size, y = initial_cv$dev)) + 
  geom_line(aes(x = initial_cv$size, y = initial_cv$dev)) + 
  ylab("CV Error Rate") + xlab("Size") + ggtitle("CV Classification Error Rate")

# pruned by CV
prune_initial <- prune.tree(initial_tree, best = 5)
plot(prune_initial)
text(prune_initial, cex = 0.65, digits = 4, pretty = 0)
```

Bagging with All Data: 
mtry = uses all the variables/predictors 
```{r}
bag_fit <- randomForest(AvgSnowfall3DayWindow ~ ., data = training, mtry = ncol(training) - 1, importance = TRUE)

bag_predict = predict(bag_fit, testing, type = "response")
bag_MSE = round(mean((testing$AvgSnowfall3DayWindow - bag_predict)^2), 4)
print(paste("Test MSE of Bagging: ", bag_MSE))

plot(bag_fit)

data.frame(bag_fit$importance) %>%
  mutate(variable = rownames(bag_fit$importance)) %>%
  mutate(variable = factor(variable, levels = variable[order(X.IncMSE)])) %>%
  ggplot() + ggtitle("Predictive Power") + xlab("% Decreasing MSE") + 
  geom_point(aes(X.IncMSE, variable))  

data.frame(bag_fit$importance) %>%
  mutate(variable = rownames(bag_fit$importance)) %>%
  mutate(variable = factor(variable, levels = variable[order(IncNodePurity)])) %>%
  ggplot() + ggtitle("Predictive Power") + xlab("Node Purity") + 
  geom_point(aes(IncNodePurity, variable))  
```









